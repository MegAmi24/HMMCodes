Library "Bridge.SetGlobalVariables" by "MegAmi"
{
    #include "Helpers" noemit

    #lib "RSDK"

    using System.Collections.Generic;

    private static bool _isInitialised = false;

    public static bool IsEnabledElementalS1 = false;
    public static bool IsEnabledS2ItemsS1 = false;
    public static bool IsEnabledSuperFormsS1 = false;

    public static bool IsEnabledElementalS2 = false;
    public static bool IsEnabledRandomS2 = false;
    public static bool IsEnabledSuperTailsS2 = false;

    UNMANAGED_FUNCTION(void, SetV4GlobalVariables)
    {
        if (RSDK.GetCurrentGame() == RSDK.Game.Sonic1)
        {
            if (IsEnabledElementalS1)
            {
                // Check if elemental shields (second bit of options.shieldType) are disabled
                if ((*(byte*)(RSDK.GetRSDKv4DataPtr() + 0x34) & 2) == 0)
                {
                    *(byte*)(RSDK.GetRSDKv4DataPtr() + 0x34) |= 2;
                }
            }
            if (IsEnabledS2ItemsS1)
            {
                // Check if S2 items (first bit of options.shieldType) are disabled
                if ((*(byte*)(RSDK.GetRSDKv4DataPtr() + 0x34) & 1) == 0)
                {
                    *(byte*)(RSDK.GetRSDKv4DataPtr() + 0x34) |= 1;
                }
            }
            if (IsEnabledSuperFormsS1)
            {
                // Check if Super forms (options.superStates) are disabled
                if (*(byte*)(RSDK.GetRSDKv4DataPtr() + 0x38) != 0x01)
                {
                    *(byte*)(RSDK.GetRSDKv4DataPtr() + 0x38) = 0x01;
                }
            }
        }
        else if (RSDK.GetCurrentGame() == RSDK.Game.Sonic2)
        {
            if (IsEnabledElementalS2)
            {
                // Check if elemental shields (first bit of options.shieldType) are disabled
                if ((*(byte*)(RSDK.GetRSDKv4DataPtr() + 0x30) & 1) == 0)
                {
                    *(byte*)(RSDK.GetRSDKv4DataPtr() + 0x30) |= 1;
                }
            }
            if (IsEnabledRandomS2)
            {
                // Check if random monitors (second bit of options.shieldType) are disabled
                if ((*(byte*)(RSDK.GetRSDKv4DataPtr() + 0x30) & 2) == 0)
                {
                    *(byte*)(RSDK.GetRSDKv4DataPtr() + 0x30) |= 2;
                }
            }
            if (IsEnabledSuperTailsS2)
            {
                // Check if Super Tails (options.superTails) is disabled
                if (*(byte*)(RSDK.GetRSDKv4DataPtr() + 0x40) != 0x01)
                {
                    *(byte*)(RSDK.GetRSDKv4DataPtr() + 0x40) = 0x01;
                }
            }
        }

        return;
    }

    [LibraryInitializer]
    public void Init()
    {
        if (_isInitialised)
            return;

        WriteAsmHook
        (
            $@"
                ; Original code, part 1
                sub rsp, 0x20

                ; Call the custom function
                mov  rsi, {GET_UNMANAGED_FUNCTION_PTR(SetV4GlobalVariables)}
                call rsi

                ; Original code, part 2
                xor ebx, ebx
                mov rsi, rcx
            ",

            /* v2.0.2: 0x1400C7824 */
            ScanSignature
            (
                "\x48\x83\xEC\x20\x33\xDB\x48\x8B\xF1",
                "xxxxxxxxx"
            ),

            HookBehavior.Replace
        );

        _isInitialised = true;
    }
}
